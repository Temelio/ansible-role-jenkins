---

# Tasks file for jenkins

- name: Load the OS specific varibles
  include_vars: "{{ role_path }}/vars/{{ ansible_os_family }}.yml"

- include: install_debian.yml
  tags:
    - install
    - jenkins
  when: ansible_os_family == "Debian"

- name: Create RSA SSH key for Jenkins user if defined
  become: True
  copy:
    dest: "{{ jenkins_etc_home_location }}/.ssh/{{ item.name }}"
    content: "{{ item.content }}"
    user: "{{ jenkins_etc_user }}"
    group: "{{ jenkins_etc_group }}"
    mode: "{{ item.mode }}"
  with_items:
    - name: 'id_rsa'
      content: "{{ jenkins_deployment_user.ssh.private }}"
      mode: '0600'
    - name: 'id_rsa.pub'
      content: "{{ jenkins_deployment_user.ssh.public }}"
      mode: '0644'
  when:
    - jenkins_deployment_user.ssh.private
    - jenkins_deployment_user.ssh.public

- name: Create SSH key for Jenkins user if not defined
  become: True
  user:
    name: "{{ jenkins_etc_user }}"
    generate_ssh_key: True

- name: Get Jenkins user deployed public key
  become: True
  command: "cat {{ jenkins_etc_home_location }}/.ssh/id_rsa.pub"
  register: jenkins_user_ssh_public_key
  changed_when: False

- name : Ensure Jenkins is started
  become  : True
  service :
    name  : "{{ jenkins_service_name }}"
    state : started

- name : Restart jenkins if new version installed
  include : "{{ role_path }}/handlers/restart_jenkins.yml"
  when : jenkins_task_package_install.changed

- name : Waiting the application is available
  include : "{{ role_path }}/handlers/waiting_jenkins.yml"

- name : Install and configure Jenkins CLI
  include: manage_cli.yml
  tags:
    - jenkins
    - install

- name : Install groovy scripts
  include: manage_groovy_scripts.yml
  tags:
    - jenkins
    - install

- name : Configure jenkins launching settings
  include: configure.yml
  tags:
    - configure
    - jenkins

- name : Manage plugins installations and upgrades
  include: plugins.yml
  tags:
    - jenkins
    - install

- name : Configure Jenkins application and its plugins
  include : "{{ role_path }}/tasks/create_config_files.yml"
  tags :
    - jenkins
    - configure

